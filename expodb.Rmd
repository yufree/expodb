---
title: "HMDB cookbook"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

## Merge database

```{r}
library(readr)
library(readxl)
# refmet
refmet <- read_excel("refmet/refmet_112718.xls")
# drugbank
drugbank <- read_csv("drugbank/drugbank.csv")
drugbank$InChIKey <- drugbank$`Standard InChI Key`
drugbanknew <- drugbank[!duplicated(drugbank$InChIKey),]
# hmdb
hmdbnew <- read_csv("hmdb/hmdbnew.csv")
# t3db
t3dbnew <- read_csv("t3db/t3dbnew.csv")
# foodb
foodb <- read_csv("foodb/compounds.csv")
foodb$InChIKey <- gsub( "InChIKey=", "", as.character(foodb$moldb_inchikey))
foodbnew <- foodb[!duplicated(foodb$InChIKey),]
# dsstox
dsstox <- read_tsv('dsstox/dsstox_20160701.tsv')
dsstoxnew <- rbind(dsstox,colnames(dsstox))
colnames(dsstoxnew) <- c('dssid','InChI','InChIKey')

list <- list(HMDB=unique(hmdbnew$InChIKey),T3DB = na.omit(unique(t3dbnew$InChIKey)), FooDB = na.omit(foodbnew$InChIKey), DrugBank = na.omit(drugbanknew$InChIKey), RefMet = na.omit(refmet$inchi_key),DSSTox = na.omit(dsstoxnew$InChIKey))

library(venn)
png('hd.png',width = 800,height = 800)
par(mfrow = c(2,3))
venn(list[c(1,6)],zcolor = hue_pal()(2),cexsn = 1.5,cexil = 1.1)
venn(list[c(2,6)],zcolor = hue_pal()(2),cexsn = 1.5,cexil = 1.1)
venn(list[c(3,6)],zcolor = hue_pal()(2),cexsn = 1.5,cexil = 1.1)
venn(list[c(4,6)],zcolor = hue_pal()(2),cexsn = 1.5,cexil = 1.1)
venn(list[c(5,6)],zcolor = hue_pal()(2),cexsn = 1.5,cexil = 1.1)
dev.off()
# all overlap
venn(list,zcolor = hue_pal()(6),cexsn = 1.5,cexil = 1.3)
library('VennDiagram')
library('scales')

list <- list(pmdpeak1,camerapeak1,pmdpeak1)
venn.diagram(list,'venn.png',fill=hue_pal()(3),margin=c(.05,.05,.05,.05),imagetype = 'png')
```

```{r}
library(readr)
cts_teeth <- read_csv("cts-20181101112732.csv")
hmdbnew <- read.csv("hmdb/hmdb.csv",stringsAsFactors = F)

sum(cts_teeth$InChIKey %in% hmdbnew$InChIKey)

teeth <- merge(cts_teeth,hmdbnew,by = 'InChIKey')
tar <- read.csv("../test/classtar.csv",stringsAsFactors = F)
teeth <- merge(tar,hmdbnew,by.x = 'smilesall',by.y = 'smiles')
teeth$kegg[!is.na(teeth$kegg)]
```

```{r}
data <- read.csv('peaklist.csv')
group <- stringr::str_replace_all(colnames(data),'\\.[:digit:]','')[-c(1,2)]
ng <- c(rep('Remote',25),rep('Clean',12),rep('Near',19))

RC <- data[,c(1:37)]
RCG <- as.factor(ng[c(1:37)])

library(genefilter)

z <- rowttests(as.matrix(RC),fac = RCG)

gct <- cbind.data.frame(m.z = data$mz,rt = data$time, t.score = z$statistic, p.value = z$p.value)
write.table(gct,file = 'gct.txt',sep = '\t',row.names = F)

NC <- data[,c(38:56,26:36)]
NCG <- as.factor(ng[c(38:56,26:36)])

library(genefilter)

z <- rowttests(as.matrix(NC),fac = NCG)

nct <- cbind.data.frame(m.z = data$mz,rt = data$time, t.score = z$statistic, p.value = z$p.value)
write.table(nct,file = 'nct.txt',sep = '\t',row.names = F)

RN <- data[,c(1:25,38:56)]
RNG <- as.factor(ng[c(1:25,38:56)])

library(genefilter)

z <- rowttests(as.matrix(RN),fac = RNG)

rnt <- cbind.data.frame(m.z = data$mz,rt = data$time, t.score = z$statistic, p.value = z$p.value)
write.table(rnt,file = 'rnt.txt',sep = '\t',row.names = F)
```
